# Телеграм Бот

## Запуск проекта

### Зависимости для запуска на локальной машине нативно

Зависимости для python приложения лежат в файле `requirements.txt`.
Желательно их устанавливать в виртуальное окружение venv.

```shell
python -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

### Переменные окружения

Скопируйте в корень проекта файл с переменными окружения `.env.dev` 
и переименуйте его в формат `*.env`. 
По умолчанию его название `.env`.

### Запуск в виртуальном окружении

Для запуска приложения нативно в папке `bot/` выполните команду
```shell
python cli.py
```

### Запуск через Docker/Docker Compose

Для корректной работы в docker compose среде обратите внимание на хост
переменные POSTGRES_HOST и REDIS_HOST. Они должны содержать названия этих 
сервисов из `docker-compose.yml`.

Для запуска проекта со всеми сервисами одновременно необходимо выполнить

```shell
docker-compose up --build -d
```

### Миграции базы данных

Управление версиями БД осуществляется с помощью пакета `alembic`.

#### Создание миграции

Для автоматического создания миграции (обновления базы в соответствии со 
схемой) выполните

```shell
alembic revision --autogenerate -m "Name of migration"
```

если проект запущен локально.

и если запущен через docker compose 

```shell
docker-compose exec bot alembic revision --autogenerate -m "Name of migration"
```

На этапе создания миграции формируется python-скрипт, который содержит
инкрементные изменения схемы БД. Его можно отредактировать и поправить 
вручную перед применением.


#### Применение миграции

Для обновления/инициализации таблиц через миграции выполните команду

```shell
alembic upgrade head
```

или для docker compose

```shell
docker-compose exec bot alembic upgrade head
```

### Админка

В панели администратора есть возможность управления сообщениями, которые отправляет бот.
Для этого надо добавить "Текст сообщений" и выбрать, какое сообщение хотите создать.

Сообщения выстраиваются в цепочку от более важных (вес) к менее важным.
В базе не может быть сообщений с одинаковым весом.